name: Docker Build & Push

on:
  push:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build & Push
        id: build
        run: |
          VERSION=$(grep -Po '(?<="version": ")[^"]*' package.json)
          IMAGE=${{ secrets.DOCKER_USERNAME }}/api-docker
          docker build -t $IMAGE:v$VERSION -t $IMAGE:latest .
          docker push $IMAGE:v$VERSION
          docker push $IMAGE:latest
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "âœ… Imagen: $IMAGE:v$VERSION"
      
      - name: Crear y pushear tag de Git
        run: |
          VERSION=$(grep -Po '(?<="version": ")[^"]*' package.json)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Verificar si el tag ya existe en remoto
          if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION$"; then
            echo "âš ï¸ Tag v$VERSION ya existe en remoto, omitiendo creaciÃ³n"
          else
            git tag -a "v$VERSION" -m "Release version $VERSION"
            git push origin "v$VERSION"
            echo "âœ… Tag v$VERSION creado y pusheado"
          fi
      
      - name: Enviar notificaciÃ³n a Telegram
        if: success()
        run: |
          VERSION="${{ steps.build.outputs.version }}"
          IMAGE="${{ steps.build.outputs.image }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          MESSAGE="ðŸš€ *Nueva imagen Docker desplegada*%0A%0A"
          MESSAGE="${MESSAGE}ðŸ“¦ *Imagen:* \`${IMAGE}\`%0A"
          MESSAGE="${MESSAGE}ðŸ·ï¸ *VersiÃ³n:* \`v${VERSION}\`%0A"
          MESSAGE="${MESSAGE}ðŸ“ *Commit:* ${COMMIT_MSG}%0A"
          MESSAGE="${MESSAGE}ðŸ”— *Docker Hub:* https://hub.docker.com/r/${IMAGE}%0A"
          MESSAGE="${MESSAGE}ðŸ‘¤ *Autor:* ${{ github.actor }}"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"