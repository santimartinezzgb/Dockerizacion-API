name: Docker Build & Push

on:
  push:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build & Push
        id: build
        run: |
          VERSION=$(grep -Po '(?<="version": ")[^"]*' package.json)
          IMAGE=${{ secrets.DOCKER_USERNAME }}/api-docker
          docker build -t $IMAGE:v$VERSION -t $IMAGE:latest .
          docker push $IMAGE:v$VERSION
          docker push $IMAGE:latest
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "‚úÖ Imagen: $IMAGE:v$VERSION"
      
      - name: Crear y pushear tag de Git
        run: |
          VERSION=$(grep -Po '(?<="version": ")[^"]*' package.json)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Verificar si el tag ya existe
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag v$VERSION ya existe, omitiendo creaci√≥n"
          else
            git tag -a "v$VERSION" -m "Release version $VERSION"
            git push origin "v$VERSION"
            echo "‚úÖ Tag v$VERSION creado y pusheado"
          fi
      
      - name: Enviar notificaci√≥n a Telegram
        if: success()
        run: |
          VERSION="${{ steps.build.outputs.version }}"
          IMAGE="${{ steps.build.outputs.image }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          MESSAGE="üöÄ *Nueva imagen Docker desplegada*%0A%0A"
          MESSAGE="${MESSAGE}üì¶ *Imagen:* \`${IMAGE}\`%0A"
          MESSAGE="${MESSAGE}üè∑Ô∏è *Versi√≥n:* \`v${VERSION}\`%0A"
          MESSAGE="${MESSAGE}üìù *Commit:* ${COMMIT_MSG}%0A"
          MESSAGE="${MESSAGE}üîó *Docker Hub:* https://hub.docker.com/r/${IMAGE}%0A"
          MESSAGE="${MESSAGE}üë§ *Autor:* ${{ github.actor }}"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"